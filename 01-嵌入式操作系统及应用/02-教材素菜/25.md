# 嵌入式操作系统及应用（第25号教案）
|课程名称|嵌入式操作系统及应用|嵌入式操作系统及应用|授课日期||
|---|---|---|---|---|
|班    级|物联网2411|物联网2412|物联网2411|物联网2412|课堂类型|一体化|
|教    材|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|
|章节名称|案例开发：MQTT协议开发|案例开发：MQTT协议开发|案例开发：MQTT协议开发|案例开发：MQTT协议开发|
|目的要求|1. 知识目标：掌握MQTT协议核心API（`NetworkInit()`、`MQTTClientInit()`、`MQTTConnect()`等）的调用方法与参数含义；理解MQTT“发布/订阅”通信模型及QoS等级（如QoS=2）的作用；熟悉MQTT服务端配置（mosquitto工具）、WiFi连接与编译配置（`BUILD.gn`/`Makefile`）步骤。<br>2. 能力目标：能独立完成RK2206开发板WiFi连接、MQTT客户端初始化与服务端通信（发布/订阅消息）；能通过串口助手与Paho工具查看通信日志，排查网络连接、服务端配置类问题。<br>3. 素养目标：结合OpenHarmony在物联网MQTT协议开发中的应用，强化国产操作系统技术认同感；通过MQTT在智能家居、工业监控等领域的应用，培养学生科技报国情怀。|
|学情分析|1. 基础：学生已掌握OpenHarmony基础操作、C语言编程及简单网络通信（如TCP）逻辑，了解开发板串口查看与编译配置基础，具备初步嵌入式网络开发能力。<br>2. 薄弱点：对MQTT“发布/订阅”模型理解较浅；对API参数（如`MQTTPacket_connectData`结构体配置、QoS等级）与服务端配置（mosquitto.conf修改）的关联逻辑不熟悉；对通信异常（如连接失败、消息收发无响应）的排查思路欠缺，需重点拆解。|
|重 难 点 分    析|1. 重点：<br> - MQTT开发全流程（WiFi连接→网络初始化→MQTT客户端初始化→连接服务端→订阅/发布消息）；<br> - 核心API调用（`NetworkConnect()`指定服务端IP/端口、`MQTTSubscribe()`订阅主题、`MQTTPublish()`发布消息）；<br> - 工具配置（mosquitto服务端安装与`mosquitto.conf`修改、Paho客户端连接与主题配置）。<br>2. 难点：<br> - `MQTTPacket_connectData`结构体配置（客户端ID、协议版本、保活间隔等参数匹配）；<br> - MQTT通信异常排查（如防火墙拦截端口、服务端IP配置错误、WiFi连接失败导致的通信中断）；<br> - QoS等级（0/1/2）的区别与实际应用场景选择（如例程中QoS=2的“恰好一次”语义）。|
|信息化应用方法|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|
|思政元素 融合设计|思政元素|融入方式|融入方式|融入方式|
|民族自豪感、科技报国情怀|1. 讲解OpenHarmony在物联网MQTT设备开发中的适配优势（如轻量、开源、低功耗），对比国外操作系统，强调国产系统对物联网产业发展的支撑作用，强化民族自豪感；<br>2. 结合MQTT在智慧农业传感器数据传输、工业设备远程监控等国计民生领域的应用，引导学生认识嵌入式技术的社会价值，树立科技报国情怀。|1. 讲解OpenHarmony在物联网MQTT设备开发中的适配优势（如轻量、开源、低功耗），对比国外操作系统，强调国产系统对物联网产业发展的支撑作用，强化民族自豪感；<br>2. 结合MQTT在智慧农业传感器数据传输、工业设备远程监控等国计民生领域的应用，引导学生认识嵌入式技术的社会价值，树立科技报国情怀。|1. 讲解OpenHarmony在物联网MQTT设备开发中的适配优势（如轻量、开源、低功耗），对比国外操作系统，强调国产系统对物联网产业发展的支撑作用，强化民族自豪感；<br>2. 结合MQTT在智慧农业传感器数据传输、工业设备远程监控等国计民生领域的应用，引导学生认识嵌入式技术的社会价值，树立科技报国情怀。|
|作业布置|1. 线上练习：完成学习通中“MQTT协议开发”相关选择题（含API参数、服务端配置、QoS等级考点）；<br>2. 线下实践：修改示例代码，将发布消息内容改为“学号+当前时间”（如“240101 15:30”）、订阅主题改为“OH_MQTT_学号”，使用Paho工具接收消息并截图，将代码与串口/Paho日志截图上传至学习平台；<br>3. 拓展思考：查阅资料，分析MQTT协议“保活机制”的作用，以及在网络不稳定场景下如何保障消息可靠传输，撰写100字以内小结。|
|参考资料|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. mosquitto下载地址：https://mosquitto.org/files/binary/<br>4. Eclipse Paho MQTT工具下载地址：https://repo.eclipse.org/content/repositories/pahoreleases/org/eclipse/paho/org.eclipse.paho.ui.app/1.1.1/|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. mosquitto下载地址：https://mosquitto.org/files/binary/<br>4. Eclipse Paho MQTT工具下载地址：https://repo.eclipse.org/content/repositories/pahoreleases/org/eclipse/paho/org.eclipse.paho.ui.app/1.1.1/|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. mosquitto下载地址：https://mosquitto.org/files/binary/<br>4. Eclipse Paho MQTT工具下载地址：https://repo.eclipse.org/content/repositories/pahoreleases/org/eclipse/paho/org.eclipse.paho.ui.app/1.1.1/|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. mosquitto下载地址：https://mosquitto.org/files/binary/<br>4. Eclipse Paho MQTT工具下载地址：https://repo.eclipse.org/content/repositories/pahoreleases/org/eclipse/paho/org.eclipse.paho.ui.app/1.1.1/|


|教学环节|教学内容|教师活动|学生活动|设计意图|
|---|---|---|---|---|
|课前|预习（30分钟）|1. 在学习平台上传预习视频（含MQTT协议基础、mosquitto工具安装教程、`iot_mqtt_thread`函数核心逻辑）；<br>2. 布置预习任务：回顾WiFi连接代码（`SetWifiModeOn()`），思考“为何MQTT通信需先连接WiFi”。|1. 观看预习视频，记录疑问（如“QoS等级有什么区别”）；<br>2. 复习网络连接知识，完成预习思考题。|提前铺垫MQTT协议与工具基础，减少课堂理解障碍，为实操环节打基础。|
|课中|课程介绍（5min）|1. 明确本节课目标：完成RK2206开发板WiFi连接与MQTT客户端配置，实现与PC端mosquitto服务端的“发布/订阅”通信（开发板发消息、Paho工具收；Paho工具发、开发板收）；<br>2. 结合OpenHarmony在智慧农业MQTT传感器开发中的案例，强调国产系统的技术价值，融入思政元素。|1. 记录课堂目标，明确学习重点；<br>2. 聆听应用案例，建立对MQTT通信实际意义的认知。|让学生清晰学习方向，以实际场景激发学习兴趣，强化民族自豪感。|
||任务导入（10min）|1. 现场演示：<br> - 配置PC端mosquitto服务端，打开Paho工具并连接；<br> - 烧录代码到开发板，按下RESET键，通过串口助手展示“MQTT连接成功、订阅主题、5秒发布一次消息”的日志；<br> - 在Paho工具发送“hello world”，展示开发板串口接收消息的日志；<br>2. 拆解核心任务：服务端配置→WiFi参数修改→代码编写→编译烧录→通信验证；<br>3. 强调关键提醒：PC端需关闭防火墙，否则MQTT连接会失败。|1. 观察演示效果，理解任务需求；<br>2. 记录任务拆解步骤，标记服务端配置要点。|通过直观演示降低任务复杂度，以“步骤拆解+关键提醒”帮助学生规避基础错误。|
||知识储备（15min）|1. 讲解核心知识点：<br> - MQTT通信模型：用“邮局”类比（服务端=邮局，客户端=用户，主题=邮箱），简化“发布/订阅”逻辑；<br> - 核心API详解：<br>   - `NetworkInit(&network)`：初始化网络结构体，为后续连接服务端铺路；<br>   - `MQTTClientInit(...)`：配置客户端超时时间、发送/接收缓冲区；<br>   - `MQTTConnect(&client, &data)`：解释`data`结构体（客户端ID=“lzdz”、协议版本=3、保活间隔=0）；<br>   - `MQTTSubscribe(...)`/`MQTTPublish(...)`：说明主题匹配（如订阅“substopic”才能收该主题消息）与QoS=2（消息恰好接收一次）；<br>2. 互动提问：“若`MQTTConnect`返回-1，可能是什么原因？”，引导学生思考连接异常排查方向。|1. 记录API用法与参数含义，结合类比理解通信模型；<br>2. 参与互动，分析连接异常的可能原因。|聚焦MQTT核心逻辑，通过类比简化原理理解，通过提问强化问题排查思维。|
||任务导入（5min）|1. 针对工具配置补充提问：“修改`mosquitto.conf`时，`allow_anonymous true`的作用是什么？不配置会怎样？”；<br>2. 明确后续重点：讲解WiFi参数修改（`config_network.c`中的SSID与密码）、MQTT服务端IP修改（`iot_mqtt.c`中的`MQTT_SERVER_IP`）的方法。|1. 思考并回答提问，理解匿名登录的必要性；<br>2. 记录参数修改要点，标记文件路径。|通过提问衔接前序知识，聚焦参数配置易错点，提前规避实操问题。|
||知识储备（10min）|1. 代码逻辑拆解：<br> - `iot_mqtt_thread`函数：分析“WiFi连接→网络初始化→MQTT连接→订阅→循环发布”的流程，标注`goto begin`（连接失败重试）的作用；<br> - 消息处理函数`message_receive`：讲解如何解析接收的消息并打印到串口；<br>2. 用“对话”类比QoS等级：QoS=0（发完不确认）、QoS=1（发完等确认，没收到重发）、QoS=2（发收双方确认，确保只收一次）。|1. 分析代码结构，标注关键函数与重试逻辑；<br>2. 结合“对话”类比，理解QoS等级差异。|用通俗类比降低QoS等级理解难度，通过代码拆解帮助学生掌握编写思路。|
||任务实施（40min）|1. 现场指导：<br> - 服务端配置：指导学生安装mosquitto，修改`mosquitto.conf`（添加listener与匿名登录配置），启动服务；<br> - 代码修改：协助学生修改WiFi参数（SSID/密码）与MQTT服务端IP（通过`ipconfig`查询）；<br> - 问题排查：对“连接失败”的学生，检查防火墙、IP配置、WiFi信号；对“消息收不到”的学生，检查主题是否匹配、QoS等级是否一致；<br>2. 阶段性检查：每完成一个步骤（服务端配置、代码修改、编译烧录），随机抽查进度，确保无学生掉队。|1. 按步骤实操：<br> - 配置PC端mosquitto服务端，打开Paho工具；<br> - 修改`config_network.c`与`iot_mqtt.c`参数，编写代码；<br> - 修改`BUILD.gn`与`Makefile`，编译烧录后验证通信；<br>2. 自主排查简单问题（如代码语法错误），复杂问题举手提问。|通过“工具+代码”双维度指导，提升学生实操与问题解决能力，确保核心任务落地。|
||任务总结（5min）|1. 成果验证：随机邀请2-3名学生展示“开发板发布消息、Paho接收”与“Paho发布、开发板接收”的双端日志；<br>2. 问题总结：梳理课堂共性问题（如防火墙未关、IP配置错误、主题不匹配），强调注意事项；<br>3. 检查工单：确认所有学生提交“任务实施工单”（含服务端配置截图、代码截图、双端通信日志截图）。|1. 展示实操成果，分享问题解决方法（如防火墙排查）；<br>2. 记录共性问题，补充笔记；<br>3. 提交任务工单，确认成果符合要求。|通过成果展示强化成就感，以问题总结巩固知识点，工单检查确保任务完成质量。|
|作业|学习通练习+实践任务|1. 在学习平台发布作业：线上选择题（10题，含API参数、QoS等级考点）+ 线下实践任务（自定义消息内容与主题）；<br>2. 提示：线下任务需在3天内上传，教师将批改并反馈拓展思考。|1. 完成线上练习，查看错题解析；<br>2. 开展线下实践，修改代码、验证通信并撰写拓展思考，按时上传。|通过“线上+线下”作业巩固课堂知识，拓展思考提升自主学习与技术分析能力。|
|课后|资源上传与复习|1. 将课堂PPT、实验指导书（含mosquitto配置步骤、代码模板、常见问题排查手册）上传至学习平台；<br>2. 汇总学生电子学习档案（含预习情况、工单提交、作业成果），标记需重点辅导的学生；<br>3. 发布复习提示：重点回顾MQTT通信流程与`MQTTPacket_connectData`结构体配置。|1. 登录学习平台下载资源，对照笔记补全知识点；<br>2. 查看学习档案，针对薄弱环节（如服务端配置）重点复习；<br>3. 遇到问题可在平台留言提问。|提供全面复习资源，帮助学生查缺补漏，通过档案汇总实现个性化辅导铺垫。|