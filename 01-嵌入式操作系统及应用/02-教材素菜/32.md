
# 嵌入式操作系统及应用（第32号教案）
|课程名称|嵌入式操作系统及应用|嵌入式操作系统及应用|授课日期||
|---|---|---|---|---|
|班    级|物联网2411|物联网2412|物联网2411|物联网2412|课堂类型|一体化|
|教    材|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|
|章节名称|案例开发：对接通鸿IoT平台的数据通讯|案例开发：对接通鸿IoT平台的数据通讯|案例开发：对接通鸿IoT平台的数据通讯|案例开发：对接通鸿IoT平台的数据通讯|
|目的要求|1. 知识目标：掌握通鸿IoT平台产品创建（含服务ID、属性与命令配置）、设备注册与密钥认证流程；理解MQTT协议在设备-云端双向通讯中的应用（状态上报+命令下发）；熟悉核心逻辑（`NetworkInit()`网络初始化、`MQTTClientInit()`客户端配置、`MQTTPublish()`/`MQTTSubscribe()`数据收发）与代码参数匹配要求。<br>2. 能力目标：能独立完成通鸿IoT平台配置、RK2206开发板WiFi连接与MAC地址修改、MQTT客户端对接与数据通讯；能通过串口与平台验证“状态上报-命令接收”全流程，排查网络冲突、MQTT连接失败及命令解析异常问题。<br>3. 素养目标：结合OpenHarmony与通鸿IoT国产平台的协同应用，强化民族自豪感；通过物联网技术在工业监控、智能设备管理中的实际价值，引导学生树立“科技赋能产业、技术报国”的情怀。|
|学情分析|1. 基础：学生已熟练掌握华为云IoT平台对接逻辑、MQTT协议基础与多线程开发经验，能独立完成传感器数据采集与执行器控制，具备嵌入式网络通讯的初步实操能力。<br>2. 薄弱点：对通鸿IoT平台“服务-属性-命令”的层级配置逻辑理解较浅；对MQTT客户端初始化（`MQTTClientInit()`）中缓冲区大小、超时时间等参数的配置意义易忽视；对命令下发后`messageArrived()`回调函数的JSON解析逻辑易混淆，需重点拆解。|
|重 难 点 分    析|1. 重点：<br> - 通鸿IoT平台配置（产品创建时服务ID=“server”、添加“状态值”属性与“下发参数”命令、设备注册时密钥与代码`MQTT_DEVICES_PWD`匹配）；<br> - 开发板与平台通讯全流程（WiFi连接→网络初始化→MQTT客户端配置→状态上报→命令接收）；<br> - 核心代码逻辑（`mqttTask`线程调度、`mqttInit`客户端初始化、`messageArrived`命令解析）。<br>2. 难点：<br> - MQTT连接参数匹配（`DEVICE_ID`与平台设备ID一致、`MQTT_DEVICES_PWD`与注册密钥一致，否则连接失败）；<br> - 命令下发后的JSON解析（`cJSON_ParseWithLength()`解析平台下发的命令体，提取“参数值”并执行对应逻辑）；<br> - 多设备同时开发时MAC地址冲突导致的WiFi连接异常排查。|
|信息化应用方法|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|
|思政元素 融合设计|思政元素|融入方式|融入方式|融入方式|
|民族自豪感、科技报国情怀|1. 讲解OpenHarmony与通鸿IoT国产技术组合的优势（轻量系统适配性强、平台部署灵活，满足物联网设备低成本接入需求），对比国外同类物联网平台，强调国产技术对产业数字化转型的支撑作用，强化民族自豪感；<br>2. 结合对接通鸿IoT的智能设备在工业监测、智能家居中的应用案例，引导学生认识嵌入式技术对实体经济的赋能价值，树立“科技赋能产业、技术报国”的情怀。|1. 讲解OpenHarmony与通鸿IoT国产技术组合的优势（轻量系统适配性强、平台部署灵活，满足物联网设备低成本接入需求），对比国外同类物联网平台，强调国产技术对产业数字化转型的支撑作用，强化民族自豪感；<br>2. 结合对接通鸿IoT的智能设备在工业监测、智能家居中的应用案例，引导学生认识嵌入式技术对实体经济的赋能价值，树立“科技赋能产业、技术报国”的情怀。|1. 讲解OpenHarmony与通鸿IoT国产技术组合的优势（轻量系统适配性强、平台部署灵活，满足物联网设备低成本接入需求），对比国外同类物联网平台，强调国产技术对产业数字化转型的支撑作用，强化民族自豪感；<br>2. 结合对接通鸿IoT的智能设备在工业监测、智能家居中的应用案例，引导学生认识嵌入式技术对实体经济的赋能价值，树立“科技赋能产业、技术报国”的情怀。|
|作业布置|1. 线上练习：完成学习通中“通鸿IoT平台对接”相关选择题（含平台配置、MQTT连接、命令解析考点）；<br>2. 线下实践：修改示例代码，新增“根据平台下发的‘参数值’控制LED亮度（如参数值=50对应50%亮度）”功能，在通鸿IoT平台添加“LED亮度”属性，将代码、串口日志与平台数据截图上传至学习平台；<br>3. 拓展思考：查阅资料，分析通鸿IoT平台“MQTT连接保活机制”的作用，以及网络中断后设备如何自动重连，撰写100字以内小结。|
|参考资料|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. 通鸿IoT平台地址：http://117.78.16.25|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. 通鸿IoT平台地址：http://117.78.16.25|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. 通鸿IoT平台地址：http://117.78.16.25|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. 通鸿IoT平台地址：http://117.78.16.25|


|教学环节|教学内容|教师活动|学生活动|设计意图|
|---|---|---|---|---|
|课前|预习（30分钟）|1. 在学习平台上传预习视频（含通鸿IoT平台注册与产品创建教程、`mqttTask`线程核心逻辑、`cJSON`解析基础）；<br>2. 布置预习任务：回顾MQTT协议“发布/订阅”模型，思考“为何设备需同时实现`MQTTPublish`与`MQTTSubscribe`功能”。|1. 观看预习视频，记录疑问（如“服务ID与属性的关联逻辑”）；<br>2. 复习MQTT通讯知识，完成预习思考题。|提前铺垫平台操作与代码核心逻辑，减少课堂理解障碍，为实操环节打基础。|
|课中|课程介绍（5min）|1. 明确本节课目标：完成通鸿IoT平台产品配置（服务/属性/命令），实现RK2206开发板与平台的MQTT双向通讯（上报“状态值”、接收“下发参数”命令），通过串口与平台验证全流程；<br>2. 结合OpenHarmony+通鸿IoT在工业物联网中的应用案例，强调国产技术价值，融入思政元素。|1. 记录课堂目标，明确学习重点；<br>2. 聆听应用案例，建立对项目实际意义的认知。|让学生清晰学习方向，以产业应用场景激发兴趣，强化民族自豪感。|
||任务导入（10min）|1. 现场演示：<br> - 登录通鸿IoT平台，展示已创建的“RK2206设备”，演示平台“状态值”属性与“下发参数”命令界面；<br> - 连接开发板与电脑，烧录测试代码，按下RESET键，通过串口展示“MQTT连接成功→状态上报→接收命令”日志，同步在平台下发“参数值=123”命令，展示开发板响应效果；<br>2. 拆解核心任务：通鸿IoT平台配置→WiFi与MAC地址修改→代码参数配置（`DEVICE_ID`/`MQTT_DEVICES_PWD`）→编译烧录→通讯验证；<br>3. 强调关键提醒：`DEVICE_ID`需与平台设备ID完全一致，`MQTT_DEVICES_PWD`需匹配注册密钥，否则MQTT连接失败。|1. 观察演示效果，理解“状态上报-命令接收”双向需求；<br>2. 记录任务拆解步骤，标记平台配置与代码参数匹配要点。|通过直观演示降低任务复杂度，以“步骤拆解+关键提醒”规避核心错误。|
||知识储备（15min）|1. 讲解核心知识点：<br> - 通鸿IoT平台逻辑：用“物联网终端身份证”类比（产品=设备类型模板，设备=具体终端，`DEVICE_ID`/`MQTT_DEVICES_PWD`=身份认证信息），简化“服务-属性-命令”层级关系；<br> - 核心代码逻辑：<br>   - 网络与MQTT初始化：`SetWifiModeOn()`开启WiFi→`NetworkInit()`初始化网络→`mqttInit()`配置MQTT客户端（设备ID、密钥、超时时间）；<br>   - 数据收发：`MQTTPublish()`上报JSON格式状态（含“services”“service_id”“properties”字段），`MQTTSubscribe()`订阅命令主题，`messageArrived()`解析下发命令；<br>   - JSON解析：`cJSON_ParseWithLength()`提取命令体中的“参数值”，实现命令响应；<br>2. 互动提问：“若`MQTTConnect()`返回非0值，可能的排查方向有哪些？”，引导学生从网络、设备ID、密钥三方面分析。|1. 记录代码逻辑与参数要求，结合类比理解平台配置；<br>2. 参与互动，梳理MQTT连接失败的排查思路。|聚焦核心逻辑与问题排查，通过类比简化平台理解，通过提问强化实操思维。|
||任务导入（5min）|1. 针对代码细节补充提问：“代码中`PUBLISH_TOPIC`与`SUBCRIB_TOPIC`的作用是什么？不匹配会导致什么问题？”；<br>2. 明确后续重点：讲解MAC地址修改方法（`hwaddr`数组最后一位改为学号后两位）、WiFi参数（`ROUTE_SSID`/`ROUTE_PASSWORD`）修改路径，以及通鸿IoT平台“服务ID=server”的强制要求。|1. 思考并回答提问，理解主题订阅与发布的必要性；<br>2. 记录MAC地址、WiFi参数修改要点，标记服务ID配置要求。|通过提问衔接前序知识，聚焦主题匹配与服务ID易错点，提前规避实操问题。|
||知识储备（10min）|1. 代码逻辑拆解：<br> - 线程调度：`TH_iot_cloud_example()`创建`mqttTask`线程，统一管理网络连接、MQTT通讯与命令处理，避免主线程阻塞；<br> - 重连机制：`mqttInit()`中`goto begin`逻辑，实现网络或MQTT连接失败后的自动重试；<br> - 命令响应：`messageArrived()`中解析命令后，通过`MQTTPublish()`上报处理结果，形成“命令下发-响应上报”闭环；<br>2. 用“物联网通讯流水线”类比：`mqttTask`=通讯调度中心，`NetworkInit()`=网络通道搭建，`MQTTClientInit()`=通讯协议配置，`messageArrived()`=命令处理站。|1. 分析代码结构，标注线程、重连机制与命令处理的关键函数；<br>2. 结合类比理解各模块协同逻辑。|用通俗类比降低复杂逻辑理解难度，通过代码拆解帮助学生掌握核心流程。|
||任务实施（40min）|1. 现场指导：<br> - 平台配置指导：巡视学生创建产品（服务ID=server）、添加“状态值”属性（枚举ON/OFF）、“下发参数”命令（参数名=参数值）、注册设备（密钥=12345678）的过程，纠正服务ID或属性名错误；<br> - 代码修改指导：协助学生修改`DEVICE_ID`（复制平台设备ID）、`MQTT_DEVICES_PWD`（12345678）、MAC地址（如`hwaddr[5]=0x05`），检查`ROUTE_SSID`/`ROUTE_PASSWORD`匹配当前WiFi；<br> - 异常排查：对“WiFi连不上”的学生检查MAC地址，对“MQTT连接失败”的学生核对`DEVICE_ID`/密钥，对“命令无响应”的学生检查`messageArrived()`解析逻辑；<br>2. 阶段性检查：每完成一个步骤（平台配置、代码修改、烧录），随机抽查进度，确保无学生掉队。|1. 按步骤实操：<br> - 配置通鸿IoT：创建产品→添加服务/属性/命令→注册设备；<br> - 修改代码：配置认证信息、WiFi与MAC地址；<br> - 编译烧录，通过串口与平台验证通讯效果；<br>2. 自主排查简单问题（如代码语法错误），复杂问题举手提问。|通过“平台+代码+硬件”三维指导，提升学生实操与问题解决能力，确保核心任务落地。|
||任务总结（5min）|1. 成果验证：随机邀请2-3名学生展示通鸿IoT平台数据与串口日志，确认“状态上报成功”“命令响应正确”；<br>2. 问题总结：梳理课堂共性问题（`DEVICE_ID`复制错误、MAC地址未修改、JSON格式错误），强调参数匹配与格式规范的重要性；<br>3. 检查工单：确认所有学生提交“任务实施工单”（含平台配置截图、代码参数截图、串口与平台数据截图）。|1. 展示实操成果，分享问题解决方法（如`DEVICE_ID`排查技巧）；<br>2. 记录共性问题，补充笔记；<br>3. 提交工单，确认成果符合要求。|通过成果展示强化成就感，以问题总结巩固知识点，工单检查确保任务完成质量。|
|作业|学习通练习+实践任务|1. 线上练习：完成学习通中“通鸿IoT对接”相关选择题（含平台配置、MQTT连接、命令解析考点）；<br>2. 线下实践：修改代码，新增“参数值控制LED闪烁频率”功能（如参数值=1对应1秒闪烁一次，参数值=2对应0.5秒闪烁一次），在通鸿IoT平台添加“LED频率”属性，上传代码与验证截图；<br>3. 拓展思考：查阅资料，分析如何实现设备离线后的数据缓存，确保网络恢复后补报，撰写100字以内小结。|1. 完成线上练习，查看错题解析；<br>2. 开展线下实践，修改代码并验证功能，撰写拓展思考；<br>3. 按时上传成果至学习平台。|通过“线上+线下”作业巩固课堂知识，拓展思考提升技术深度。|
|课后|资源上传与复习|1. 将课堂PPT、实验指导书（含通鸿IoT配置步骤、代码模板、常见问题排查手册）上传至学习平台；<br>2. 汇总学生电子学习档案（含预习情况、工单提交、作业成果），标记需重点辅导的学生；<br>3. 发布复习提示：重点回顾MQTT连接参数匹配、JSON格式规范与命令解析逻辑。|1. 登录学习平台下载资源，对照笔记补全知识点；<br>2. 查看学习档案，针对薄弱环节（如命令解析）重点复习；<br>3. 遇到问题可在平台留言提问。|提供全面复习资源，帮助学生查缺补漏，通过档案汇总实现个性化辅导。|