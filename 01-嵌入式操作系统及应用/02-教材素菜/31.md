# 嵌入式操作系统及应用（第31号教案）
|课程名称|嵌入式操作系统及应用|嵌入式操作系统及应用|授课日期||
|---|---|---|---|---|
|班    级|物联网2411|物联网2412|物联网2411|物联网2412|课堂类型|一体化|
|教    材|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|OpenHarmony嵌入式系统原理与应用——基于RK2206芯片|
|章节名称|案例开发：华为云IoT的智慧农业应用|案例开发：华为云IoT的智慧农业应用|案例开发：华为云IoT的智慧农业应用|案例开发：华为云IoT的智慧农业应用|
|目的要求|1. 知识目标：掌握华为云IoT平台“智慧农业”产品创建（含温度、湿度、亮度、紫光灯/电机状态属性与控制命令）、设备注册与MQTT接入配置；理解智慧农业模块（E53_IA）多参数采集逻辑（温度/湿度/亮度）与执行器（紫光灯/电机）联动规则；熟悉核心API（`device_info_init()`、`oc_mqtt_init()`、`oc_mqtt_profile_propertyreport()`）的调用与“属性上报-命令下发”双向通信流程。<br>2. 能力目标：能独立完成华为云IoT多属性与命令配置、RK2206开发板WiFi连接与MAC地址修改、智慧农业数据采集与执行器控制；能通过串口与华为云平台验证“属性上报-命令下发”双向数据，排查网络冲突、设备认证及命令响应异常类问题。<br>3. 素养目标：结合OpenHarmony与华为云在智慧农业领域的国产技术协同，强化民族自豪感；通过智慧农业在精准种植、节水节能中的应用，引导学生树立“科技赋能农业、技术报国”的情怀。|
|学情分析|1. 基础：学生已熟练掌握华为云IoT单属性配置、MQTT协议与多线程消息队列逻辑，具备传感器数据采集与执行器控制开发经验，能独立完成编译配置与硬件接线检查。<br>2. 薄弱点：对华为云“属性上报+命令下发”双向通信逻辑理解较浅；对多参数（温度/湿度/亮度）批量上报格式与代码结构体的匹配易遗漏；对命令响应回调函数（`ia_cmd_response_callback`）的触发机制不熟悉，需重点拆解。|
|重 难 点 分    析|1. 重点：<br> - 华为云IoT平台配置（“智慧农业”产品创建时服务ID=“智慧农业”、批量添加5类属性+2类命令，设备注册时密钥认证，MQTT接入IP/端口配置）；<br> - 智慧农业模块开发全流程（WiFi连接→MAC地址修改→模块初始化→多参数采集→执行器联动→华为云双向通信）；<br> - 核心API调用（`device_info_init()`配置认证信息、`oc_mqtt_profile_propertyreport()`上报多参数、`oc_set_cmd_rsp_cb()`注册命令回调函数）。<br>2. 难点：<br> - 华为云“命令下发”与开发板“命令响应”的双向逻辑（如平台下发“紫光灯控制”命令，开发板通过`ia_deal_cmd_msg()`处理并执行）；<br> - 多参数批量上报格式（`ia_msg_t`结构体中`temp`/`hum`/`lum`字段与华为云属性的精准匹配）；<br> - 命令响应异常排查（如回调函数未注册导致命令无响应、命令参数枚举值不匹配）。|
|信息化应用方法|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|网络教学平台、视频、开发板，开展现场教学，通过项目任务驱动进行混合式教学；|
|思政元素 融合设计|思政元素|融入方式|融入方式|融入方式|
|民族自豪感、科技报国情怀|1. 讲解OpenHarmony与华为云在智慧农业领域的技术协同优势（轻量系统适配多传感器与执行器，实现“数据采集-云端分析-命令控制”闭环），对比国外农业物联网技术方案，强调国产技术对农业现代化的支撑作用，强化民族自豪感；<br>2. 结合智慧农业在节水灌溉、精准施肥中的实际价值，引导学生认识嵌入式技术对国家粮食安全与乡村振兴的意义，树立“科技赋能农业、技术报国”的情怀。|1. 讲解OpenHarmony与华为云在智慧农业领域的技术协同优势（轻量系统适配多传感器与执行器，实现“数据采集-云端分析-命令控制”闭环），对比国外农业物联网技术方案，强调国产技术对农业现代化的支撑作用，强化民族自豪感；<br>2. 结合智慧农业在节水灌溉、精准施肥中的实际价值，引导学生认识嵌入式技术对国家粮食安全与乡村振兴的意义，树立“科技赋能农业、技术报国”的情怀。|1. 讲解OpenHarmony与华为云在智慧农业领域的技术协同优势（轻量系统适配多传感器与执行器，实现“数据采集-云端分析-命令控制”闭环），对比国外农业物联网技术方案，强调国产技术对农业现代化的支撑作用，强化民族自豪感；<br>2. 结合智慧农业在节水灌溉、精准施肥中的实际价值，引导学生认识嵌入式技术对国家粮食安全与乡村振兴的意义，树立“科技赋能农业、技术报国”的情怀。|
|作业布置|1. 线上练习：完成学习通中“华为云IoT智慧农业”相关选择题（含双向通信、命令配置、多参数上报考点）；<br>2. 线下实践：修改示例代码，新增“温度超标（＞28℃）自动开启电机”功能，在华为云添加“温度阈值”属性，将代码、串口日志与华为云数据截图上传至学习平台；<br>3. 拓展思考：查阅资料，分析智慧农业模块若需实现“远程精准灌溉（根据湿度自动控制水泵）”，需补充哪些硬件（如水泵模块）与软件逻辑，撰写100字以内小结。|
|参考资料|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. 华为云IoT平台地址：https://www.huaweicloud.com/product/iotdm.html|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. 华为云IoT平台地址：https://www.huaweicloud.com/product/iotdm.html|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. 华为云IoT平台地址：https://www.huaweicloud.com/product/iotdm.html|1. OpenHarmony嵌入式系统原理与应用——基于RK2206芯片<br>2. https://gitee.com/Lockzhiner-Electronics/lockzhiner-rk2206-openharmony3.0lts.git<br>3. 华为云IoT平台地址：https://www.huaweicloud.com/product/iotdm.html|


|教学环节|教学内容|教师活动|学生活动|设计意图|
|---|---|---|---|---|
|课前|预习（30分钟）|1. 在学习平台上传预习视频（含华为云IoT“属性+命令”配置教程、E53_IA模块多参数采集逻辑、`oc_set_cmd_rsp_cb()`回调函数用法）；<br>2. 布置预习任务：回顾消息队列双向通信流程，思考“为何智慧农业需要‘属性上报+命令下发’双向交互”。|1. 观看预习视频，记录疑问（如“命令回调函数如何触发”）；<br>2. 复习多线程与MQTT双向通信知识，完成预习思考题。|提前铺垫云平台双向通信、多参数采集与命令回调基础，减少课堂理解障碍，为实操环节打基础。|
|课中|课程介绍（5min）|1. 明确本节课目标：完成华为云IoT“智慧农业”产品配置（含多属性与控制命令），实现RK2206开发板采集温度/湿度/亮度数据、联动紫光灯/电机，并支持华为云下发命令控制执行器，通过串口与云端验证双向数据；<br>2. 结合OpenHarmony+华为云在智慧农业中的应用案例（如精准种植），强调国产技术价值，融入思政元素。|1. 记录课堂目标，明确学习重点；<br>2. 聆听应用案例，建立对智慧农业项目实际意义的认知。|让学生清晰学习方向，以农业现代化场景激发学习兴趣，强化民族自豪感。|
||任务导入（10min）|1. 现场演示：<br> - 登录华为云平台，展示“智慧农业”产品的多属性（温度/湿度/亮度）与控制命令（紫光灯/电机）配置；<br> - 连接智慧农业模块与开发板，烧录代码后按下RESET键，通过串口展示“多参数采集+紫光灯/电机联动”日志，在华为云下发“电机控制”命令，展示执行器响应效果；<br>2. 拆解核心任务：云平台“属性+命令”配置→WiFi与MAC地址修改→代码参数配置→编译烧录→双向通信验证；<br>3. 强调关键提醒：多人开发需修改MAC地址（避免WiFi冲突），华为云命令参数枚举值（ON/OFF）需与代码完全一致。|1. 观察演示效果，理解“属性上报-命令下发”双向需求；<br>2. 记录任务拆解步骤，标记云平台命令配置要点。|通过直观演示降低任务复杂度，以“步骤拆解+关键提醒”规避基础错误。|
||知识储备（15min）|1. 讲解核心知识点：<br> - 华为云IoT双向通信逻辑：用“农业监测终端身份证”类比（产品=智慧农业设备型号，设备=具体监测终端，ClientId/Username/Password=认证信息），简化“属性+命令”配置逻辑；<br> - 核心API详解：<br>   - `device_info_init(...)`：配置华为云认证信息，参数不匹配会导致设备离线；<br>   - `oc_mqtt_init()`：初始化MQTT客户端，返回0为成功，-1/-2需排查网络或设备信息；<br>   - `oc_mqtt_profile_propertyreport(...)`：批量上报多参数，`payload`需包含`temp`/`hum`/`lum`字段；<br>   - `oc_set_cmd_rsp_cb(...)`：注册命令回调函数，确保云端下发命令能被开发板响应；<br> - 模块工作逻辑：讲解E53_IA初始化（`e53_ia_init()`）、多参数读取（`e53_ia_read_data()`）与执行器联动规则（亮度低→紫光灯开、温湿度超标→电机开）；<br>2. 互动提问：“华为云下发‘电机控制=ON’命令时，开发板通过哪个函数处理该命令？”，引导学生关注命令回调逻辑。|1. 记录API用法与参数含义，结合类比理解双向通信逻辑；<br>2. 参与互动，分析命令处理函数的作用。|聚焦核心API与双向通信逻辑，通过类比简化云平台理解，通过提问强化命令回调思维。|
||任务导入（5min）|1. 针对命令配置补充提问：“华为云添加‘紫光灯控制’命令时，‘参数枚举值’为何必须设为ON/OFF？代码中哪部分判断该参数？”；<br>2. 明确后续重点：讲解MAC地址修改方法（`hwaddr`数组最后一位改为学号后两位）、WiFi参数（`ROUTE_SSID`/`ROUTE_PASSWORD`）修改路径，以及华为云命令下发后代码的处理流程（`ia_deal_cmd_msg()`）。|1. 思考并回答提问，理解命令参数匹配的必要性；<br>2. 记录MAC地址、WiFi参数修改要点，标记命令处理代码路径。|通过提问衔接前序知识，聚焦命令配置易错点，提前规避实操问题。|
||知识储备（10min）|1. 代码逻辑拆解：<br> - 多线程与消息队列：分析`iot_cloud_ia_example`函数（创建消息队列→创建采集/处理线程），说明“`e53_ia_thread`采集多参数→消息队列传递→`iot_cloud_ia_thread`上报属性/处理命令”的协同逻辑；<br> - 命令处理流程：讲解`oc_set_cmd_rsp_cb(ia_cmd_response_callback)`注册回调函数，当云端下发命令时，`ia_deal_cmd_msg()`解析参数并控制执行器；<br>2. 用“农业数据处理中心”类比多线程：`e53_ia_thread`=数据采集站，消息队列=数据传输通道，`iot_cloud_ia_thread`=云端交互站（上报数据+接收命令）。|1. 分析代码结构，标注线程、消息队列与命令处理的关键函数；<br>2. 结合类比理解双向通信的多线程协同逻辑。|用通俗类比降低多线程与命令处理理解难度，通过代码分析掌握核心流程。|
||任务实施（40min）|1. 现场指导：<br> - 云平台指导：巡视学生配置“属性+命令”，纠正命令参数枚举值错误；<br> - 代码修改指导：协助学生修改MAC地址（如`hwaddr[5] = 0x05`）、WiFi参数，检查华为云认证信息的代码配置；<br> - 异常排查：对“命令无响应”的学生，排查回调函数是否注册；对“属性上报不全”的学生，核对云端属性名与代码字段；<br>2. 阶段性检查：每完成一个步骤（云配置、代码修改、烧录），随机抽查进度，确保无学生掉队。|1. 按步骤实操：<br> - 配置华为云：创建产品→添加属性与命令→注册设备；<br> - 修改代码：配置MAC地址、WiFi、华为云认证信息；<br> - 编译烧录，通过串口与云端验证双向通信；<br>2. 自主排查简单问题（如参数格式错误），复杂问题举手提问。|通过“云平台+代码+硬件”三维度指导，提升学生实操与问题解决能力，确保双向通信任务落地。|
||任务总结（5min）|1. 成果验证：随机邀请2-3名学生展示华为云多属性数据与串口命令响应日志，确认“属性上报完整+命令响应正确”；<br>2. 问题总结：梳理课堂共性问题（如命令回调未注册、枚举值不匹配、MAC地址冲突），强调注意事项；<br>3. 检查工单：确认所有学生提交“任务实施工单”（含云配置截图、代码截图、串口/云端数据截图）。|1. 展示实操成果，分享命令响应异常的排查方法；<br>2. 记录共性问题，补充笔记；<br>3. 提交工单，确认成果符合要求。|通过成果展示强化成就感，以问题总结巩固知识点，工单检查确保任务完成质量。|
|作业|学习通练习+实践任务|1. 在学习平台发布作业：线上选择题（10题，含双向通信、命令配置、多参数上报考点）+ 线下实践任务（新增温度阈值控制功能）；<br>2. 提示：线下任务需在3天内上传，教师将批改并反馈拓展思考。|1. 完成线上练习，查看错题解析；<br>2. 开展线下实践，修改代码并验证功能，撰写拓展思考。|通过“线上+线下”作业巩固课堂知识，拓展思考提升技术分析能力。|
|课后|资源上传与复习|1. 将课堂PPT、实验指导书（含云平台“属性+命令”配置步骤、代码模板、MAC地址修改示例、常见问题排查手册）上传至学习平台；<br>2. 汇总学生电子学习档案（含预习情况、工单提交、作业成果），标记需重点辅导的学生；<br>3. 发布复习提示：重点回顾华为云双向通信流程与命令回调函数逻辑。|1. 登录学习平台下载资源，对照笔记补全知识点；<br>2. 查看学习档案，针对薄弱环节（如命令处理）重点复习；<br>3. 遇到问题可在平台留言提问。|提供全面复习资源，帮助学生查缺补漏，通过档案汇总实现个性化辅导。|